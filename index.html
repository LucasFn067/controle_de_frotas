<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Frota - Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* üé® Estilo: Tema azul e branco, moderno e responsivo */
        :root {
            --primary-color: #007bff; /* Azul principal */
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #343a40;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background-color: var(--card-background);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 450px;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
        }

        /* Estilos de Formul√°rio */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        button:hover {
            background-color: #0056b3;
        }

        #message {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: var(--border-radius);
            display: none;
        }

        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }

        /* Estilos dos Pain√©is */
        .dashboard {
            max-width: 1200px;
            padding: 20px;
            min-height: 100vh;
            background-color: var(--background-color);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .header h2 {
            color: var(--primary-color);
            margin: 0;
        }

        .card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 10px 15px;
            border: none;
            background-color: #e9ecef;
            cursor: pointer;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            margin-right: 5px;
            transition: background-color 0.3s;
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .tab-content {
            border: 1px solid #ddd;
            border-top: none;
            padding: 20px;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table th, table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        table th {
            background-color: #f1f1f1;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            margin: 2px;
        }
    </style>
</head>
<body>

    <div id="login-view" class="container">
        <h1>Acesso ao Sistema</h1>
        <div id="message"></div>
        <form id="login-form">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Senha</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit">Entrar</button>
        </form>
    </div>

    <div id="dashboard-view" class="dashboard" style="display: none;">
        <div class="header">
            <h2>Painel de Controle</h2>
            <button id="logout-btn">Sair</button>
        </div>

        <div id="admin-dashboard" style="display: none;">
            <div class="card">
                <h3>Gest√£o de Motoristas e Ve√≠culos</h3>
                <button class="tab-button active" onclick="showTab('drivers-tab')">Motoristas</button>
                <button class="tab-button" onclick="showTab('vehicles-tab')">Ve√≠culos</button>

                <div id="drivers-tab" class="tab-content active">
                    <h4>Gerenciar Motoristas</h4>
                    <button onclick="showAddDriverModal()">Adicionar Motorista</button>
                    <div id="drivers-list">
                        </div>
                </div>

                <div id="vehicles-tab" class="tab-content">
                    <h4>Gerenciar Ve√≠culos</h4>
                    <button onclick="showAddVehicleModal()">Adicionar Ve√≠culo</button>
                    <div id="vehicles-list">
                        </div>
                </div>
            </div>
            
            <div class="card">
                <h3>Relat√≥rios e A√ß√µes de Viagem</h3>
                <div class="form-group">
                    <label for="report-driver-select">Motorista para Relat√≥rio/A√ß√£o:</label>
                    <select id="report-driver-select"></select>
                </div>
                <button onclick="generateReportLast7Days()">Gerar Relat√≥rio (7 Dias)</button>
                <button onclick="generateReportLast30Days()">Gerar Relat√≥rio (30 Dias)</button>
                <button onclick="showTripManagement()">Gerenciar Viagens (Excluir/Zerar KM)</button>
            </div>

            <div id="trip-management-modal" class="card" style="display: none;">
                <h4>Gerenciar Viagens do Motorista Selecionado</h4>
                <div id="trips-list-admin">
                    </div>
            </div>
        </div>

        <div id="driver-dashboard" style="display: none;">
            <div class="card">
                <h3>Painel do Motorista: Iniciar/Finalizar Viagem</h3>
                <div class="form-group">
                    <label for="driver-vehicle-select">Selecione o Ve√≠culo:</label>
                    <select id="driver-vehicle-select"></select>
                </div>
                <div class="form-group">
                    <label for="driver-destino">Destino:</label>
                    <input type="text" id="driver-destino" required>
                </div>
                <div class="form-group">
                    <label for="driver-km-inicial">Km Inicial:</label>
                    <input type="number" id="driver-km-inicial" required step="0.01">
                </div>
                <button onclick="startTrip()">Iniciar Viagem</button>

                <hr style="margin: 20px 0;">

                <h4>Finalizar Viagem Atual</h4>
                <div class="form-group">
                    <label for="driver-km-final">Km Final:</label>
                    <input type="number" id="driver-km-final" step="0.01">
                </div>
                <button onclick="finishTrip()">Finalizar Viagem</button>
            </div>

            <div class="card">
                <h4>Minhas Viagens Ativas e Conclu√≠das</h4>
                <div id="driver-trips-list">
                    </div>
            </div>
        </div>

    </div>

    <div id="modal-backdrop" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; margin: 10% auto; padding: 20px; width: 80%; max-width: 500px; border-radius: var(--border-radius); box-shadow: var(--shadow);">
            <h4 id="modal-title">T√≠tulo do Modal</h4>
            <form id="modal-form">
                </form>
            <button style="background: var(--secondary-color); margin-top: 15px;" onclick="closeModal()">Fechar</button>
        </div>
    </div>


    <script>
        // ------------------------------------------------------
        // ‚öôÔ∏è CONFIGURA√á√ÉO DO SUPABASE
        // Substitua pelas suas chaves reais do Supabase
        // ------------------------------------------------------
        const SUPABASE_URL = 'https://nrgmjkphxdyyqjchhcto.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yZ21qa3BoeGR5eXFqY2hoY3RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNDYzMzUsImV4cCI6MjA3NjgyMjMzNX0.eDmA3YfrxO5ZPDVxps2Sy3OT6RlhpPmU838n7jJZmF8';

        if (SUPABASE_URL === 'SUA_URL_DO_SUPABASE' || SUPABASE_ANON_KEY === 'SUA_CHAVE_ANON_DO_SUPABASE') {
            alert("ATEN√á√ÉO: Por favor, configure as vari√°veis SUPABASE_URL e SUPABASE_ANON_KEY no script.");
        }

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        let CURRENT_USER = user;

        // ------------------------------------------------------
        // üî† FUN√á√ïES GLOBAIS E UTILIT√ÅRIOS
        // ------------------------------------------------------

        /** Mostra uma mensagem na tela de login. */
        function showMessage(msg, type = 'error') {
            const msgElement = document.getElementById('message');
            msgElement.textContent = msg;
            msgElement.className = type === 'success' ? 'success' : 'error';
            msgElement.style.display = 'block';
            setTimeout(() => {
                msgElement.style.display = 'none';
            }, 5000);
        }
        
        /** Mostra/Esconde as views de dashboard com base no usu√°rio. */
        async function initializeApp() {
            const loginView = document.getElementById('login-view');
            const dashboardView = document.getElementById('dashboard-view');
            
            const { data: { user } } = await supabase.auth.getSession();
            CURRENT_USER = user;

            if (user) {
                loginView.style.display = 'none';
                dashboardView.style.display = 'block';
                await loadUserData(user.id);
            } else {
                dashboardView.style.display = 'none';
                loginView.style.display = 'flex';
                document.getElementById('admin-dashboard').style.display = 'none';
                document.getElementById('driver-dashboard').style.display = 'none';
            }
        }

        /** Carrega dados do usu√°rio e redireciona para o painel correto. */
        async function loadUserData(userId) {
            const { data, error } = await supabase
                .from('motoristas')
                .select('role')
                .eq('id', userId)
                .single();

            if (error) {
                console.error("Erro ao buscar perfil do usu√°rio:", error);
                showMessage("Erro ao carregar perfil. Tente novamente.", 'error');
                return;
            }

            if (data && data.role === 'admin') {
                document.getElementById('admin-dashboard').style.display = 'block';
                document.getElementById('driver-dashboard').style.display = 'none';
                loadAdminData();
            } else if (data && data.role === 'motorista') {
                document.getElementById('admin-dashboard').style.display = 'none';
                document.getElementById('driver-dashboard').style.display = 'block';
                loadDriverData(userId);
            } else {
                console.warn("Usu√°rio sem fun√ß√£o definida ou n√£o encontrado:", data);
                showMessage("Usu√°rio n√£o autorizado ou sem fun√ß√£o. Fa√ßa logout.", 'error');
                document.getElementById('admin-dashboard').style.display = 'none';
                document.getElementById('driver-dashboard').style.display = 'none';
            }
        }

        /** Fun√ß√£o para trocar as abas do painel do gestor. */
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[onclick*="${tabId}"]`).classList.add('active');
        }

        // ------------------------------------------------------
        // üö™ FUN√á√ïES DE AUTENTICA√á√ÉO
        // ------------------------------------------------------

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            // Nota: O Supabase Auth gerencia senhas para o signUp/signIn. 
            // No nosso caso, vamos usar 'signInWithPassword' para o login, 
            // mas o 'role' vem da nossa tabela 'motoristas'.
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                showMessage("Erro no login: " + error.message, 'error');
                return;
            }
            
            showMessage("Login bem-sucedido!", 'success');
            initializeApp(); // Redireciona e carrega dados
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error("Erro ao fazer logout:", error.message);
            }
            CURRENT_USER = null;
            initializeApp(); // Volta para a tela de login
        });

        // ------------------------------------------------------
        // üßë‚Äçüíº FUN√á√ïES DO PAINEL DO GESTOR (ADMIN)
        // ------------------------------------------------------

        async function loadAdminData() {
            await loadDriversList();
            await loadVehiclesList();
            await populateDriverSelects();
        }

        // --- Gest√£o de Motoristas ---

        async function loadDriversList() {
            const { data: drivers, error } = await supabase
                .from('motoristas')
                .select('id, nome, email, role');

            const listDiv = document.getElementById('drivers-list');
            listDiv.innerHTML = '';

            if (error) {
                listDiv.innerHTML = `<p class="error">Erro ao carregar motoristas: ${error.message}</p>`;
                return;
            }

            if (!drivers || drivers.length === 0) {
                listDiv.innerHTML = '<p>Nenhum motorista cadastrado.</p>';
                return;
            }

            let html = '<table><thead><tr><th>Nome</th><th>Email</th><th>Role</th><th>A√ß√µes</th></tr></thead><tbody>';
            drivers.forEach(driver => {
                html += `
                    <tr>
                        <td>${driver.nome}</td>
                        <td>${driver.email}</td>
                        <td>${driver.role}</td>
                        <td>
                            <button class="btn-small" onclick="showEditDriverModal('${driver.id}', '${driver.nome}', '${driver.email}', '${driver.role}')">Alterar Senha</button>
                            <button class="btn-small" style="background-color: #dc3545;" onclick="deleteDriver('${driver.id}', '${driver.nome}')">Excluir</button>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            listDiv.innerHTML = html;
        }

        function showAddDriverModal() {
            document.getElementById('modal-title').textContent = 'Adicionar Novo Motorista';
            document.getElementById('modal-form').innerHTML = `
                <div class="form-group"><label>Nome</label><input type="text" id="modal-driver-nome" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="modal-driver-email" required></div>
                <div class="form-group"><label>Senha Inicial (Usu√°rio dever√° alterar/usar para login)</label><input type="password" id="modal-driver-senha" required></div>
                <input type="hidden" id="modal-driver-id" value="">
                <input type="hidden" id="modal-driver-role" value="motorista">
            `;
            const modalForm = document.getElementById('modal-form');
            modalForm.onsubmit = handleAddOrUpdateDriver;
            document.getElementById('modal-backdrop').style.display = 'block';
        }

        async function handleAddOrUpdateDriver(e) {
            e.preventDefault();
            const id = document.getElementById('modal-driver-id').value;
            const nome = document.getElementById('modal-driver-nome').value;
            const email = document.getElementById('modal-driver-email').value;
            const senha = document.getElementById('modal-driver-senha').value;
            const role = document.getElementById('modal-driver-role').value;

            if (id) {
                // Atualiza√ß√£o (Apenas senha e role no backend) - Mudan√ßa de senha √© complexa com Supabase Auth + DB.
                // Aqui, vamos apenas atualizar o DB para simplificar, pois a senha do Auth deve ser gerenciada por ele.
                const { error } = await supabase
                    .from('motoristas')
                    .update({ nome, email, role })
                    .eq('id', id);

                if (error) {
                    showMessage(`Erro ao atualizar motorista: ${error.message}`);
                    return;
                }
                showMessage(`Motorista ${nome} atualizado com sucesso!`, 'success');
            } else {
                // Adicionar Motorista (No Supabase Auth + DB)
                // 1. Cria o usu√°rio no Auth (Isso n√£o cria o registro na tabela 'motoristas')
                const { user: newUser, error: authError } = await supabase.auth.admin.createUser({
                    email: email,
                    password: senha,
                    data: { role: role, nome: nome }
                });

                if (authError) {
                    showMessage(`Erro ao criar usu√°rio/motorista: ${authError.message}. Verifique se o email j√° existe ou se sua chave de Admin est√° correta.`, 'error');
                    return;
                }
                
                // 2. Insere o registro na tabela 'motoristas'
                const { error: dbError } = await supabase
                    .from('motoristas')
                    .insert({ id: newUser.id, nome, email, role, senha: senha }); // Guardando senha temporariamente no DB como solicitado

                if (dbError) {
                    console.error("Erro ao inserir no DB motoristas:", dbError);
                    showMessage(`Usu√°rio criado no Auth, mas falha ao inserir no DB: ${dbError.message}`, 'error');
                    return;
                }
                
                showMessage(`Motorista ${nome} adicionado com sucesso!`, 'success');
            }

            closeModal();
            loadDriversList();
            populateDriverSelects();
        }

        function showEditDriverModal(id, nome, email, role) {
            document.getElementById('modal-title').textContent = `Alterar Senha/Dados do Motorista: ${nome}`;
            document.getElementById('modal-form').innerHTML = `
                <div class="form-group"><label>Nome</label><input type="text" id="modal-driver-nome" value="${nome}" required></div>
                <div class="form-group"><label>Email</label><input type="email" id="modal-driver-email" value="${email}" required></div>
                <div class="form-group"><label>Nova Senha (Opcional)</label><input type="password" id="modal-driver-senha" placeholder="Deixe em branco para n√£o alterar a senha no Auth"></div>
                <div class="form-group"><label>Role</label><select id="modal-driver-role"><option value="motorista" ${role === 'motorista' ? 'selected' : ''}>motorista</option><option value="admin" ${role === 'admin' ? 'selected' : ''}>admin</option></select></div>
                <input type="hidden" id="modal-driver-id" value="${id}">
            `;
            const modalForm = document.getElementById('modal-form');
            modalForm.onsubmit = async (e) => {
                e.preventDefault();
                const newNome = document.getElementById('modal-driver-nome').value;
                const newEmail = document.getElementById('modal-driver-email').value;
                const newSenha = document.getElementById('modal-driver-senha').value;
                const newRole = document.getElementById('modal-driver-role').value;

                let updateData = { nome: newNome, email: newEmail, role: newRole };
                
                // Apenas atualiza a senha no Auth se um valor for fornecido
                if (newSenha) {
                    const { error: authError } = await supabase.auth.admin.updateUserById(id, { password: newSenha });
                    if (authError) {
                        showMessage(`Erro ao atualizar senha no Auth: ${authError.message}`, 'error');
                        return;
                    }
                    updateData.senha = newSenha; // Atualiza no DB tamb√©m
                }

                const { error: dbError } = await supabase
                    .from('motoristas')
                    .update(updateData)
                    .eq('id', id);

                if (dbError) {
                    showMessage(`Erro ao atualizar dados no DB: ${dbError.message}`, 'error');
                    return;
                }

                showMessage(`Dados do motorista ${nome} atualizados com sucesso!`, 'success');
                closeModal();
                loadDriversList();
                populateDriverSelects();
            };
            document.getElementById('modal-backdrop').style.display = 'block';
        }


        async function deleteDriver(id, nome) {
            if (!confirm(`Tem certeza que deseja excluir o motorista ${nome}?`)) return;

            // 1. Excluir do Auth (Necessita de permiss√£o de Admin no Supabase)
            const { error: authError } = await supabase.auth.admin.deleteUser(id);
            if (authError) {
                console.error("Erro ao deletar do Auth:", authError);
                // Tentativa de deletar do DB mesmo com falha no Auth para limpeza parcial
            }
            
            // 2. Excluir da tabela motoristas
            const { error: dbError } = await supabase.from('motoristas').delete().eq('id', id);

            if (dbError) {
                showMessage(`Erro ao excluir motorista do banco de dados: ${dbError.message}`, 'error');
                return;
            }

            showMessage(`Motorista ${nome} exclu√≠do com sucesso.`, 'success');
            loadDriversList();
            populateDriverSelects();
        }

        // --- Gest√£o de Ve√≠culos ---

        async function loadVehiclesList() {
            const { data: vehicles, error } = await supabase
                .from('veiculos')
                .select('id, modelo, placa');

            const listDiv = document.getElementById('vehicles-list');
            listDiv.innerHTML = '';

            if (error) {
                listDiv.innerHTML = `<p class="error">Erro ao carregar ve√≠culos: ${error.message}</p>`;
                return;
            }

            if (!vehicles || vehicles.length === 0) {
                listDiv.innerHTML = '<p>Nenhum ve√≠culo cadastrado.</p>';
                return;
            }

            let html = '<table><thead><tr><th>Modelo</th><th>Placa</th><th>A√ß√µes</th></tr></thead><tbody>';
            vehicles.forEach(vehicle => {
                html += `
                    <tr>
                        <td>${vehicle.modelo}</td>
                        <td>${vehicle.placa}</td>
                        <td><button class="btn-small" style="background-color: #dc3545;" onclick="deleteVehicle('${vehicle.id}', '${vehicle.placa}')">Excluir</button></td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            listDiv.innerHTML = html;
        }

        function showAddVehicleModal() {
            document.getElementById('modal-title').textContent = 'Adicionar Novo Ve√≠culo';
            document.getElementById('modal-form').innerHTML = `
                <div class="form-group"><label>Modelo</label><input type="text" id="modal-vehicle-modelo" required></div>
                <div class="form-group"><label>Placa</label><input type="text" id="modal-vehicle-placa" required></div>
            `;
            document.getElementById('modal-form').onsubmit = handleAddOrUpdateVehicle;
            document.getElementById('modal-backdrop').style.display = 'block';
        }

        async function handleAddOrUpdateVehicle(e) {
            e.preventDefault();
            const modelo = document.getElementById('modal-vehicle-modelo').value;
            const placa = document.getElementById('modal-vehicle-placa').value.toUpperCase();

            const { error } = await supabase
                .from('veiculos')
                .insert({ modelo, placa });

            if (error) {
                showMessage(`Erro ao adicionar ve√≠culo: ${error.message}`, 'error');
                return;
            }

            showMessage(`Ve√≠culo ${modelo} (${placa}) adicionado com sucesso!`, 'success');
            closeModal();
            loadVehiclesList();
            loadDriverVehicleSelect(); // Atualiza a lista do motorista
        }

        async function deleteVehicle(id, placa) {
            if (!confirm(`Tem certeza que deseja excluir o ve√≠culo placa ${placa}?`)) return;

            const { error } = await supabase.from('veiculos').delete().eq('id', id);

            if (error) {
                showMessage(`Erro ao excluir ve√≠culo: ${error.message}`, 'error');
                return;
            }

            showMessage(`Ve√≠culo placa ${placa} exclu√≠do com sucesso.`, 'success');
            loadVehiclesList();
            loadDriverVehicleSelect();
        }

        // --- Relat√≥rios e Gest√£o de Viagens (Admin) ---

        async function populateDriverSelects() {
            const { data: drivers, error } = await supabase.from('motoristas').select('id, nome');
            const selectEl = document.getElementById('report-driver-select');
            const driverSelectEl = document.getElementById('driver-vehicle-select'); // Para o motorista
            selectEl.innerHTML = '';
            driverSelectEl.innerHTML = '';
            
            if (error || !drivers) return;

            drivers.forEach(driver => {
                const optionAdmin = document.createElement('option');
                optionAdmin.value = driver.id;
                optionAdmin.textContent = `${driver.nome} (${driver.id.substring(0, 4)}...)`;
                selectEl.appendChild(optionAdmin);

                if (CURRENT_USER && CURRENT_USER.id === driver.id) {
                    const optionDriver = document.createElement('option');
                    optionDriver.value = driver.id;
                    optionDriver.textContent = driver.nome;
                    driverSelectEl.appendChild(optionDriver);
                }
            });

            // Carregar ve√≠culos para o gestor, para que ele possa selecionar para o motorista
            await loadVehiclesList();
            if (drivers.length > 0) {
                 driverSelectEl.innerHTML = '<option value="">Selecione um ve√≠culo</option>'; // Op√ß√£o padr√£o para o motorista
                document.querySelectorAll('#vehicles-list table tbody tr').forEach((row, index) => {
                    const placa = row.cells[1].textContent;
                    const modelo = row.cells[0].textContent;
                    const id = row.cells[2].querySelector('.btn-small').onclick.toString().match(/'(.*?)'/)[1]; // Pega o ID da fun√ß√£o deleteVehicle
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${modelo} - ${placa}`;
                    driverSelectEl.appendChild(option);
                });
            }
        }

        // Fun√ß√£o para o gestor visualizar e gerenciar viagens de um motorista espec√≠fico
        document.getElementById('report-driver-select').addEventListener('change', showTripManagement);
        async function showTripManagement() {
            const driverId = document.getElementById('report-driver-select').value;
            const tripsDiv = document.getElementById('trips-list-admin');
            tripsDiv.innerHTML = 'Carregando viagens...';

            if (!driverId) {
                tripsDiv.innerHTML = '<p>Selecione um motorista para ver as viagens.</p>';
                return;
            }

            const { data: trips, error } = await supabase
                .from('viagens')
                .select(`
                    id, 
                    destino, 
                    km_inicial, 
                    km_final, 
                    data_inicio, 
                    data_fim, 
                    status,
                    veiculos (placa)
                `)
                .eq('motorista_id', driverId)
                .order('data_inicio', { ascending: false });

            if (error) {
                tripsDiv.innerHTML = `<p class="error">Erro ao carregar viagens: ${error.message}</p>`;
                return;
            }

            if (!trips || trips.length === 0) {
                tripsDiv.innerHTML = '<p>Nenhuma viagem encontrada para este motorista.</p>';
                return;
            }

            let html = '<table><thead><tr><th>Placa</th><th>Destino</th><th>In√≠cio</th><th>Fim</th><th>Status</th><th>A√ß√µes</th></tr></thead><tbody>';
            trips.forEach(trip => {
                const kmPercorrido = (trip.km_final && trip.km_inicial) ? (trip.km_final - trip.km_inicial).toFixed(2) : 'N/A';
                html += `
                    <tr>
                        <td>${trip.veiculos.placa}</td>
                        <td>${trip.destino}</td>
                        <td>${new Date(trip.data_inicio).toLocaleString()}</td>
                        <td>${trip.data_fim ? new Date(trip.data_fim).toLocaleString() : 'Em Aberto'}</td>
                        <td>${trip.status}</td>
                        <td>
                            <button class="btn-small" style="background-color: #dc3545;" onclick="deleteTrip('${trip.id}')">Excluir</button>
                            ${trip.status !== 'conclu√≠da' && trip.km_inicial ? 
                                `<button class="btn-small" style="background-color: orange;" onclick="resetKmAndFinishTrip('${trip.id}', ${trip.km_inicial})">Finalizar/Zerar KM (Simulado)</button>` : ''}
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            tripsDiv.innerHTML = html;
        }

        async function deleteTrip(tripId) {
            if (!confirm("Tem certeza que deseja excluir esta viagem?")) return;

            const { error } = await supabase.from('viagens').delete().eq('id', tripId);
            if (error) {
                showMessage(`Erro ao excluir viagem: ${error.message}`, 'error');
                return;
            }
            showMessage('Viagem exclu√≠da com sucesso!', 'success');
            showTripManagement(); // Recarrega a lista
        }

        async function resetKmAndFinishTrip(tripId, kmInicial) {
             if (!confirm("Tem certeza que deseja FINALIZAR a viagem como 'conclu√≠da' E zerar a quilometragem (Definir KM Final = KM Inicial)? Isso √© para corrigir um erro de inser√ß√£o.")) return;

             const { error } = await supabase
                .from('viagens')
                .update({ km_final: kmInicial, data_fim: new Date().toISOString(), status: 'conclu√≠da' })
                .eq('id', tripId);

            if (error) {
                showMessage(`Erro ao finalizar/zerar viagem: ${error.message}`, 'error');
                return;
            }
            showMessage('Viagem finalizada e KM zerado com sucesso!', 'success');
            showTripManagement();
        }

        // --- Gera√ß√£o de Relat√≥rio PDF (jsPDF) ---
        async function generateReport(days) {
            const driverId = document.getElementById('report-driver-select').value;
            if (!driverId) {
                showMessage("Selecione um motorista para gerar o relat√≥rio.", 'error');
                return;
            }

            const driverName = document.getElementById('report-driver-select').options[document.getElementById('report-driver-select').selectedIndex].text.split(' (')[0];
            
            const dateLimit = new Date();
            dateLimit.setDate(dateLimit.getDate() - days);

            const { data: trips, error } = await supabase
                .from('viagens')
                .select(`
                    id, 
                    destino, 
                    km_inicial, 
                    km_final, 
                    data_inicio, 
                    data_fim,
                    veiculos (modelo, placa)
                `)
                .eq('motorista_id', driverId)
                .gte('data_inicio', dateLimit.toISOString())
                .eq('status', 'conclu√≠da')
                .order('data_inicio', { ascending: false });

            if (error) {
                showMessage(`Erro ao buscar dados para relat√≥rio: ${error.message}`, 'error');
                return;
            }

            if (!trips || trips.length === 0) {
                showMessage(`Nenhuma viagem conclu√≠da nos √∫ltimos ${days} dias para ${driverName}.`, 'error');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: "p",
                unit: "mm",
                format: "a4"
            });

            doc.setFontSize(18);
            doc.text(`Relat√≥rio de Viagens - ${driverName}`, 20, 20);
            doc.setFontSize(12);
            doc.text(`Per√≠odo: √öltimos ${days} dias`, 20, 28);
            
            let y = 40;
            const rowHeight = 10;
            const margin = 20;

            trips.forEach((trip, index) => {
                const dataInicio = new Date(trip.data_inicio).toLocaleDateString('pt-BR');
                const dataFim = trip.data_fim ? new Date(trip.data_fim).toLocaleDateString('pt-BR') : 'N/A';
                const kmPercorrido = (trip.km_final && trip.km_inicial) ? (trip.km_final - trip.km_inicial).toFixed(2) : 'N/A';
                
                doc.setFont(undefined, 'bold');
                doc.text(`Viagem #${index + 1}`, margin, y);
                doc.setFont(undefined, 'normal');
                
                doc.text(`Ve√≠culo: ${trip.veiculos.modelo} (${trip.veiculos.placa})`, margin, y + rowHeight);
                doc.text(`Destino: ${trip.destino}`, margin, y + rowHeight * 2);
                doc.text(`Data In√≠cio: ${dataInicio}`, margin, y + rowHeight * 3);
                doc.text(`Data Fim: ${dataFim}`, margin, y + rowHeight * 4);
                doc.text(`Km Inicial: ${trip.km_inicial.toFixed(2)}`, margin, y + rowHeight * 5);
                doc.text(`Km Final: ${trip.km_final ? trip.km_final.toFixed(2) : 'N/A'}`, margin, y + rowHeight * 6);
                doc.text(`Km Percorrido: ${kmPercorrido}`, margin, y + rowHeight * 7);
                
                y += rowHeight * 9; // Pula para a pr√≥xima se√ß√£o

                if (y > 270) { // Verifica se precisa de nova p√°gina
                    doc.addPage();
                    y = 20;
                }
            });

            // Campo de assinatura
            doc.setFont(undefined, 'bold');
            doc.text("Assinatura do Gestor:", margin, y + 20);
            doc.line(margin + 50, y + 30, margin + 150, y + 30); // Linha de assinatura
            doc.setFont(undefined, 'normal');
            doc.text(`Relat√≥rio gerado em: ${new Date().toLocaleString()}`, margin, 280);

            doc.save(`Relatorio_Viagens_${driverName}_${days}dias.pdf`);
            showMessage(`Relat√≥rio de ${days} dias gerado com sucesso!`, 'success');
        }

        function generateReportLast7Days() {
            generateReport(7);
        }

        function generateReportLast30Days() {
            generateReport(30);
        }


        // ------------------------------------------------------
        // üöó FUN√á√ïES DO PAINEL DO MOTORISTA
        // ------------------------------------------------------

        async function loadDriverData(driverId) {
            // Popula a sele√ß√£o de ve√≠culos
            await loadDriverVehicleSelect(driverId);
            // Carrega as viagens do motorista
            await loadDriverTrips(driverId);
        }

        async function loadDriverVehicleSelect(driverId) {
            const selectEl = document.getElementById('driver-vehicle-select');
            selectEl.innerHTML = '<option value="">Selecione um ve√≠culo</option>';

            const { data: vehicles, error } = await supabase.from('veiculos').select('id, modelo, placa');
            
            if (error || !vehicles) return;

            vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.id;
                option.textContent = `${vehicle.modelo} - ${vehicle.placa}`;
                selectEl.appendChild(option);
            });
        }

        async function loadDriverTrips(driverId) {
            const tripsDiv = document.getElementById('driver-trips-list');
            tripsDiv.innerHTML = 'Carregando minhas viagens...';

            const { data: trips, error } = await supabase
                .from('viagens')
                .select(`
                    id, 
                    destino, 
                    km_inicial, 
                    km_final, 
                    data_inicio, 
                    data_fim, 
                    status,
                    veiculos (modelo, placa)
                `)
                .eq('motorista_id', driverId)
                .order('data_inicio', { ascending: false });

            if (error) {
                tripsDiv.innerHTML = `<p class="error">Erro ao carregar suas viagens: ${error.message}</p>`;
                return;
            }

            if (!trips || trips.length === 0) {
                tripsDiv.innerHTML = '<p>Nenhuma viagem registrada ainda.</p>';
                return;
            }

            let html = '<table><thead><tr><th>Ve√≠culo</th><th>Destino</th><th>In√≠cio</th><th>Fim</th><th>Status</th><th>KM Percorrido</th></tr></thead><tbody>';
            trips.forEach(trip => {
                const kmPercorrido = (trip.km_final && trip.km_inicial) ? (trip.km_final - trip.km_inicial).toFixed(2) + ' km' : 'Aguardando KM Final';
                const dataInicio = new Date(trip.data_inicio).toLocaleString();
                const dataFim = trip.data_fim ? new Date(trip.data_fim).toLocaleString() : 'Em Aberto';
                
                html += `
                    <tr>
                        <td>${trip.veiculos.modelo} (${trip.veiculos.placa})</td>
                        <td>${trip.destino}</td>
                        <td>${dataInicio}</td>
                        <td>${dataFim}</td>
                        <td>${trip.status}</td>
                        <td>${kmPercorrido}</td>
                    </tr>
                `;
            });
            html += '</tbody></table>';
            tripsDiv.innerHTML = html;
        }

        async function startTrip() {
            const driverId = CURRENT_USER.id;
            const veiculo_id = document.getElementById('driver-vehicle-select').value;
            const destino = document.getElementById('driver-destino').value;
            const km_inicial = parseFloat(document.getElementById('driver-km-inicial').value);

            if (!veiculo_id || !destino || isNaN(km_inicial) || km_inicial < 0) {
                showMessage("Preencha todos os campos corretamente para iniciar a viagem.", 'error');
                return;
            }
            
            // Verifica se j√° existe uma viagem aberta
            const { data: openTrip, error: checkError } = await supabase
                .from('viagens')
                .select('id')
                .eq('motorista_id', driverId)
                .eq('status', 'aberta');

            if (openTrip && openTrip.length > 0) {
                showMessage("Voc√™ j√° tem uma viagem aberta. Finalize-a antes de iniciar outra.", 'error');
                return;
            }

            const { data, error } = await supabase.from('viagens').insert({
                motorista_id: driverId,
                veiculo_id: veiculo_id,
                destino: destino,
                km_inicial: km_inicial,
                data_inicio: new Date().toISOString(),
                status: 'aberta'
            }).select();

            if (error) {
                showMessage(`Erro ao iniciar viagem: ${error.message}`, 'error');
                return;
            }

            showMessage(`Viagem iniciada para ${destino} com sucesso!`, 'success');
            document.getElementById('driver-destino').value = '';
            document.getElementById('driver-km-inicial').value = '';
            loadDriverTrips(driverId);
        }

        async function finishTrip() {
            const driverId = CURRENT_USER.id;
            const km_final = parseFloat(document.getElementById('driver-km-final').value);

            if (isNaN(km_final) || km_final < 0) {
                showMessage("Digite um valor v√°lido para a quilometragem final.", 'error');
                return;
            }

            // 1. Encontrar a viagem aberta
            const { data: openTrips, error: checkError } = await supabase
                .from('viagens')
                .select('id, km_inicial')
                .eq('motorista_id', driverId)
                .eq('status', 'aberta')
                .limit(1);

            if (checkError || !openTrips || openTrips.length === 0) {
                showMessage("Nenhuma viagem aberta encontrada para finalizar.", 'error');
                return;
            }

            const tripToFinish = openTrips[0];
            
            if (km_final < tripToFinish.km_inicial) {
                showMessage(`A quilometragem final (${km_final.toFixed(2)} km) n√£o pode ser menor que a inicial (${tripToFinish.km_inicial.toFixed(2)} km).`, 'error');
                return;
            }

            // 2. Atualizar a viagem
            const { error: updateError } = await supabase
                .from('viagens')
                .update({
                    km_final: km_final,
                    data_fim: new Date().toISOString(),
                    status: 'conclu√≠da'
                })
                .eq('id', tripToFinish.id);

            if (updateError) {
                showMessage(`Erro ao finalizar viagem: ${updateError.message}`, 'error');
                return;
            }

            showMessage("Viagem finalizada com sucesso!", 'success');
            document.getElementById('driver-km-final').value = '';
            loadDriverTrips(driverId);
        }


        // ------------------------------------------------------
        // üóô MODAIS
        // ------------------------------------------------------
        function closeModal() {
            document.getElementById('modal-backdrop').style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById('modal-backdrop')) {
                closeModal();
            }
        }
    </script>
    <script>
        // Inicializa a aplica√ß√£o ao carregar
        initializeApp();
    </script>
</body>
</html>
