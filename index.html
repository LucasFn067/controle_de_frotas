<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FleetControl - Sistema de Controle de Frota</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .bg-primary { background-color: #6B8E23; }
        .bg-primary-light { background-color: #8FBC8F; }
        .bg-primary-dark { background-color: #556B2F; }
        .text-primary { color: #6B8E23; }
        .border-primary { border-color: #6B8E23; }
        .hover\:bg-primary-dark:hover { background-color: #556B2F; }
        .focus\:border-primary:focus { border-color: #6B8E23; }
        .focus\:ring-primary:focus { --tw-ring-color: #6B8E23; }
    </style>
</head>
<body class="bg-gray-50 min-h-full">
    <div id="loginScreen" class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div class="text-center">
                <div class="mx-auto h-16 w-16 bg-primary rounded-full flex items-center justify-center">
                    <svg class="h-8 w-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h2 class="mt-6 text-3xl font-extrabold text-gray-900">FleetControl</h2>
                <p class="mt-2 text-sm text-gray-600">Sistema de Controle de Frota</p>
            </div>
            <form class="mt-8 space-y-6" onsubmit="handleLogin(event)">
                <div class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700">Usuário (E-mail)</label>
                        <input id="username" name="username" type="text" required 
                               class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-primary focus:border-primary focus:z-10 sm:text-sm" 
                               placeholder="Digite seu e-mail (gestor@frota.com)">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                        <input id="password" name="password" type="password" required 
                               class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-primary focus:border-primary focus:z-10 sm:text-sm" 
                               placeholder="Digite sua senha">
                    </div>
                </div>
                <div>
                    <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                        Entrar
                    </button>
                </div>
                <div class="text-xs text-gray-500 text-center">
                    <p>Agora use as credenciais criadas no Painel de Auth do Supabase.</p>
                </div>
            </form>
        </div>
    </div>

    <div id="managerDashboard" class="hidden min-h-full">
        <header class="bg-primary shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center">
                        <h1 class="text-2xl font-bold text-white">FleetControl - Painel do Gestor</h1>
                    </div>
                    <button onclick="logout()" class="bg-primary-dark hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Sair
                    </button>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8">
                    <button onclick="showTab('drivers')" id="driversTab" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        Motoristas
                    </button>
                    <button onclick="showTab('vehicles')" id="vehiclesTab" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        Veículos
                    </button>
                    <button onclick="showTab('trips')" id="tripsTab" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        Viagens
                    </button>
                    <button onclick="showTab('reports')" id="reportsTab" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                        Relatórios
                    </button>
                </nav>
            </div>
        </div>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div id="driversContent" class="tab-content">
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Gestão de Motoristas</h3>
                    </div>
                    <div class="p-6">
                        <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <h4 class="text-md font-medium text-yellow-800 mb-4">Atenção!</h4>
                            <p class="text-sm text-yellow-700">A criação de novos motoristas deve ser feita no Painel de Auth do Supabase (para criar o e-mail/senha). O registro aqui é automático via RLS.</p>
                        </div>

                        <div>
                            <h4 class="text-md font-medium text-gray-900 mb-4">Motoristas Cadastrados</h4>
                            <div id="driversList" class="space-y-3">
                                </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="vehiclesContent" class="tab-content hidden">
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Gestão de Veículos</h3>
                    </div>
                    <div class="p-6">
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                            <h4 class="text-md font-medium text-gray-900 mb-4">Adicionar Veículo</h4>
                            <form onsubmit="addVehicle(event)" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="vehiclePlate" class="block text-sm font-medium text-gray-700">Placa</label>
                                    <input type="text" id="vehiclePlate" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                                </div>
                                <div>
                                    <label for="vehicleModel" class="block text-sm font-medium text-gray-700">Modelo</label>
                                    <input type="text" id="vehicleModel" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                                </div>
                                <div class="flex items-end">
                                    <button type="submit" class="w-full bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-md text-sm font-medium">
                                        Adicionar
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div>
                            <h4 class="text-md font-medium text-gray-900 mb-4">Veículos Cadastrados</h4>
                            <div id="vehiclesList" class="space-y-3">
                                </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tripsContent" class="tab-content hidden">
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Gestão de Viagens</h3>
                    </div>
                    <div class="p-6">
                        <div class="mb-6">
                            <label for="tripDriverSelect" class="block text-sm font-medium text-gray-700 mb-2">Selecionar Motorista</label>
                            <select id="tripDriverSelect" onchange="loadDriverTrips()" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                                <option value="">Selecione um motorista</option>
                            </select>
                        </div>

                        <div id="tripsActions" class="hidden mb-6 flex space-x-4">
                            <button onclick="clearAllTrips()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                Zerar Todas as Viagens
                            </button>
                        </div>

                        <div id="tripsList">
                            </div>
                    </div>
                </div>
            </div>

            <div id="reportsContent" class="tab-content hidden">
                <div class="bg-white shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-medium text-gray-900">Geração de Relatórios</h3>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label for="reportDriverSelect" class="block text-sm font-medium text-gray-700 mb-2">Motorista</label>
                                <select id="reportDriverSelect" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                                    <option value="">Selecione um motorista</option>
                                </select>
                            </div>
                            <div>
                                <label for="reportPeriod" class="block text-sm font-medium text-gray-700 mb-2">Período</label>
                                <select id="reportPeriod" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                                    <option value="7">Últimos 7 dias</option>
                                    <option value="30">Últimos 30 dias</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button onclick="generateReport()" class="w-full bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-md text-sm font-medium">
                                    Gerar Relatório PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="driverDashboard" class="hidden min-h-full">
        <header class="bg-primary shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center">
                        <h1 class="text-2xl font-bold text-white">FleetControl - Painel do Motorista</h1>
                    </div>
                    <button onclick="logout()" class="bg-primary-dark hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Sair
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div id="activeTripSection" class="hidden mb-8">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                    <h3 class="text-lg font-medium text-yellow-800 mb-4">Viagem em Andamento</h3>
                    <div id="activeTripDetails" class="mb-4">
                        </div>
                    <div class="flex space-x-4">
                        <div class="flex-1">
                            <label for="finalKm" class="block text-sm font-medium text-gray-700 mb-2">KM Final</label>
                            <input type="number" id="finalKm" class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                        </div>
                        <div class="flex items-end">
                            <button onclick="finishTrip()" class="bg-primary hover:bg-primary-dark text-white px-6 py-2 rounded-md text-sm font-medium">
                                Concluir Viagem
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="newTripSection" class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Registrar Nova Viagem</h3>
                </div>
                <div class="p-6">
                    <form onsubmit="startTrip(event)" class="space-y-4">
                        <div>
                            <label for="tripDestination" class="block text-sm font-medium text-gray-700 mb-2">Destino</label>
                            <input type="text" id="tripDestination" required class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                        </div>
                        <div>
                            <label for="tripVehicle" class="block text-sm font-medium text-gray-700 mb-2">Veículo</label>
                            <select id="tripVehicle" required class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                                <option value="">Selecione um veículo</option>
                            </select>
                        </div>
                        <div>
                            <label for="initialKm" class="block text-sm font-medium text-gray-700 mb-2">KM Inicial</label>
                            <input type="number" id="initialKm" required class="block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary focus:border-primary sm:text-sm">
                        </div>
                        <button type="submit" class="w-full bg-primary hover:bg-primary-dark text-white px-4 py-3 rounded-md text-sm font-medium">
                            Iniciar Viagem
                        </button>
                    </form>
                </div>
            </div>

            <div class="mt-8 bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Histórico de Viagens</h3>
                </div>
                <div class="p-6">
                    <div id="driverTripHistory">
                        </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // **********************************************
        // CONFIGURAÇÃO SUPABASE
        // **********************************************
        const SUPABASE_URL = 'https://nrgmjkphxdyyqjchhcto.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5yZ21qa3BoeGR5eXFqY2hoY3RvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNDYzMzUsImV4cCI6MjA3NjgyMjMzNX0.eDmA3YfrxO5ZPDVxps2Sy3OT6RlhpPmU838n7jJZmF8'; 

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null; 
        let drivers = [];   
        let vehicles = [];  
        let trips = [];     

        // **********************************************
        // FUNÇÃO DE AUTENTICAÇÃO CORRIGIDA (AGORA VIA SUPABASE AUTH + DRIVERS UNIFICADA)
        // **********************************************

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // 1. Tenta autenticar via Supabase Auth (válido para Gestor e Motorista)
            const { data: authData, error: authError } = await supabase.auth.signInWithPassword({
                email: email, 
                password: password,
            });
            
            if (authError) {
                alert('Erro de login: Usuário ou senha incorretos, ou e-mail não confirmado.');
                return;
            }

            // 2. Busca o perfil (agora unificado na tabela 'drivers') para determinar a role e o ID numérico
            const userUid = authData.user.id;
            const { data: driverInfo, error: driverInfoError } = await supabase
                .from('drivers')
                .select('id, name, role') // Seleciona o ID numérico, nome e role
                .eq('auth_uid', userUid) // Usa o UUID de Auth como chave de busca
                .single();

            if (driverInfoError || !driverInfo) {
                // Este erro agora refere-se a problemas de RLS na tabela drivers ou falha na criação do registro pelo trigger.
                alert('Erro de perfil. O login foi bem-sucedido, mas o perfil não está configurado corretamente. Verifique o RLS da tabela drivers ou se o usuário foi criado corretamente no Table Editor.');
                await supabase.auth.signOut();
                return;
            }

            // 3. Redireciona com base na ROLE
            if (driverInfo.role === 'manager') {
                // currentUser.id é o ID numérico da tabela drivers
                currentUser = { type: 'manager', id: driverInfo.id, name: driverInfo.name, auth_uid: userUid }; 
                showManagerDashboard();
            } else if (driverInfo.role === 'driver') {
                 // currentUser.id é o ID numérico da tabela drivers
                 currentUser = { type: 'driver', id: driverInfo.id, name: driverInfo.name, auth_uid: userUid };
                 showDriverDashboard();
            } else {
                 alert('Role de usuário desconhecida. Favor contatar o administrador.');
                 await supabase.auth.signOut();
            }
        }

        async function logout() {
            await supabase.auth.signOut(); 
            
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('managerDashboard').classList.add('hidden');
            document.getElementById('driverDashboard').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function showManagerDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('managerDashboard').classList.remove('hidden');
            showTab('drivers');
            loadDriversData();
            loadVehiclesData();
        }

        async function showDriverDashboard() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('driverDashboard').classList.remove('hidden');
            await loadVehiclesData(); 
            loadDriverVehicles();
            checkActiveTrip();
            loadDriverTripHistory();
        }

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('border-primary', 'text-primary');
                button.classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            const activeTab = document.getElementById(tabName + 'Tab');
            activeTab.classList.remove('border-transparent', 'text-gray-500');
            activeTab.classList.add('border-primary', 'text-primary');

            // Chamada de recarregamento ao mudar de aba
            if (tabName === 'drivers') loadDriversData();
            if (tabName === 'vehicles') loadVehiclesData();
            if (tabName === 'trips' || tabName === 'reports') {
                updateDriverSelects();
                document.getElementById('tripDriverSelect').value = '';
                document.getElementById('tripsList').innerHTML = '';
            }
        }

        // **********************************************
        // GESTÃO DE MOTORISTAS SUPABASE (Ajustada para RLS e Auth)
        // **********************************************

        async function loadDriversData() {
            const driversList = document.getElementById('driversList');
            driversList.innerHTML = '<p class="text-gray-500">Carregando motoristas...</p>';

            // Busca na tabela drivers, que agora contém as roles
            const { data, error } = await supabase
                .from('drivers')
                .select('id, name, username, auth_uid')
                .order('name', { ascending: true });

            if (error) {
                driversList.innerHTML = `<p class="text-red-500">Erro ao carregar motoristas: ${error.message}</p>`;
                return;
            }
            
            drivers = data; // Atualiza a lista global
            updateDriverSelects();

            driversList.innerHTML = '';
            if (drivers.length === 0) {
                driversList.innerHTML = '<p class="text-gray-500">Nenhum motorista cadastrado.</p>';
                return;
            }
            
            drivers.forEach(driver => {
                const driverDiv = document.createElement('div');
                driverDiv.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
                driverDiv.innerHTML = `
                    <div>
                        <h5 class="font-medium text-gray-900">${driver.name}</h5>
                        <p class="text-sm text-gray-500">Usuário: ${driver.username}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="changeDriverPassword('${driver.auth_uid}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                            Alterar Senha
                        </button>
                        <button onclick="deleteDriver('${driver.auth_uid}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                            Excluir
                        </button>
                    </div>
                `;
                driversList.appendChild(driverDiv);
            });
        }

        async function addDriver(event) {
            event.preventDefault();
            alert('Motoristas devem ser criados/convidados diretamente no Painel de Autenticação do Supabase (Authentication -> Users). O RLS e os Triggers se encarregam de criar o perfil no banco de dados.');
        }

        // Função de alteração de senha atualizada para usar o Supabase Auth (Apenas placeholder, requer Admin)
        async function changeDriverPassword(driverAuthUid) {
            alert('A alteração de senha de outro usuário (Gestor para Motorista) requer uma Função de Administrador ou Edge Function do Supabase (Admin API). \n\nPara o front-end, o motorista deve usar o fluxo de "esqueci minha senha" do Supabase Auth, que envia um e-mail de redefinição.');
        }

        // Função de exclusão atualizada para excluir do Auth
        async function deleteDriver(driverAuthUid) {
            if (confirm('Tem certeza que deseja excluir este motorista? O usuário Auth, o registro Driver e todas as Viagens (trips) dele serão removidos.')) {
                
                // Excluir o usuário do Auth. Isso disparará o CASCADE no SQL
                // para a tabela 'drivers' e consequentemente 'trips'.
                const { error: authError } = await supabase.rpc('delete_user_by_id', { user_id: driverAuthUid });

                if (authError) {
                    // O rpc 'delete_user_by_id' é necessário para que um usuário não-administrador
                    // (que é a role do front-end) possa excluir outro usuário. Se você não 
                    // criou essa função RPC, o erro abaixo ocorrerá. 
                    // Para fins práticos neste exemplo, faremos a exclusão no Auth por enquanto:
                     const { error: finalAuthError } = await supabase.auth.admin.deleteUser(driverAuthUid);
                    
                    if (finalAuthError) {
                        alert('Erro ao excluir usuário Auth: É necessário usar o Auth Admin API ou a função RPC "delete_user_by_id" com a chave "service_role" no backend. Para testes, exclua manualmente em "Authentication -> Users"');
                        return;
                    }

                    // Se a exclusão do Auth funcionar, o CASCADE cuida do resto.
                    
                }
                
                loadDriversData();
            }
        }

        // **********************************************
        // GESTÃO DE VEÍCULOS SUPABASE (Usando snake_case para colunas)
        // **********************************************

        async function loadVehiclesData() {
            const vehiclesList = document.getElementById('vehiclesList');
            vehiclesList.innerHTML = '<p class="text-gray-500">Carregando veículos...</p>';

            const { data, error } = await supabase
                .from('vehicles')
                .select('*')
                .order('plate', { ascending: true });

            if (error) {
                vehiclesList.innerHTML = `<p class="text-red-500">Erro ao carregar veículos: ${error.message}</p>`;
                return;
            }
            
            vehicles = data; // Atualiza a lista global

            vehiclesList.innerHTML = '';
            if (vehicles.length === 0) {
                vehiclesList.innerHTML = '<p class="text-gray-500">Nenhum veículo cadastrado.</p>';
                return;
            }
            
            vehicles.forEach(vehicle => {
                const vehicleDiv = document.createElement('div');
                vehicleDiv.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
                vehicleDiv.innerHTML = `
                    <div>
                        <h5 class="font-medium text-gray-900">${vehicle.plate}</h5>
                        <p class="text-sm text-gray-500">${vehicle.model}</p>
                    </div>
                    <button onclick="deleteVehicle(${vehicle.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                        Excluir
                    </button>
                `;
                vehiclesList.appendChild(vehicleDiv);
            });
        }

        async function addVehicle(event) {
            event.preventDefault();
            const plate = document.getElementById('vehiclePlate').value;
            const model = document.getElementById('vehicleModel').value;

            const { data: existing } = await supabase
                .from('vehicles')
                .select('id')
                .eq('plate', plate);

            if (existing && existing.length > 0) {
                alert('Placa já cadastrada!');
                return;
            }

            const newVehicle = {
                plate: plate,
                model: model
            };

            const { error } = await supabase
                .from('vehicles')
                .insert([newVehicle]);

            if (error) {
                alert('Erro ao adicionar veículo: ' + error.message);
                return;
            }

            document.getElementById('vehiclePlate').value = '';
            document.getElementById('vehicleModel').value = '';
            loadVehiclesData();
        }

        async function deleteVehicle(vehicleId) {
            if (confirm('Tem certeza que deseja excluir este veículo?')) {
                const { error } = await supabase
                    .from('vehicles')
                    .delete()
                    .eq('id', vehicleId);

                if (error) {
                    alert('Erro ao excluir veículo: ' + error.message);
                    return;
                }
                
                loadVehiclesData();
            }
        }

        // **********************************************
        // GESTÃO DE VIAGENS - GESTOR SUPABASE (Usando snake_case para colunas)
        // **********************************************
        
        function updateDriverSelects() {
            const selects = ['tripDriverSelect', 'reportDriverSelect'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                // Preserve the first option (placeholder)
                const optionsToKeep = select.querySelector('option[value=""]'); 
                select.innerHTML = '';
                if (optionsToKeep) select.appendChild(optionsToKeep);

                drivers.forEach(driver => {
                    const option = document.createElement('option');
                    option.value = driver.id; // ID Numérico
                    option.textContent = driver.name;
                    select.appendChild(option);
                });
            });
        }

        async function loadDriverTrips() {
            const driverId = parseInt(document.getElementById('tripDriverSelect').value);
            const tripsList = document.getElementById('tripsList');
            const tripsActions = document.getElementById('tripsActions');
            
            tripsActions.classList.add('hidden');
            tripsList.innerHTML = '';

            if (!driverId) return;

            tripsList.innerHTML = '<p class="text-gray-500">Carregando viagens...</p>';
            
            const { data, error } = await supabase
                .from('trips')
                .select('*')
                .eq('driver_id', driverId) 
                .order('start_time', { ascending: false }); 

            if (error) {
                tripsList.innerHTML = `<p class="text-red-500">Erro ao carregar viagens: ${error.message}</p>`;
                return;
            }

            trips = data; // Atualiza lista global
            tripsActions.classList.remove('hidden');

            if (trips.length === 0) {
                tripsList.innerHTML = '<p class="text-gray-500">Nenhuma viagem encontrada.</p>';
                return;
            }
            
            tripsList.innerHTML = '<div class="space-y-3"></div>';
            const tripsContainer = tripsList.querySelector('.space-y-3');

            trips.forEach(trip => {
                const vehicle = vehicles.find(v => v.id === trip.vehicle_id); 
                const tripDiv = document.createElement('div');
                tripDiv.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
                
                const statusBadge = trip.status === 'completed' 
                    ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">Concluída</span>'
                    : '<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs">Em andamento</span>';

                tripDiv.innerHTML = `
                    <div>
                        <h5 class="font-medium text-gray-900">${trip.destination}</h5>
                        <p class="text-sm text-gray-500">${vehicle ? vehicle.plate + ' - ' + vehicle.model : 'Veículo não encontrado'}</p>
                        <p class="text-sm text-gray-500">Início: ${new Date(trip.start_time).toLocaleString('pt-BR')}</p>
                        ${trip.end_time ? `<p class="text-sm text-gray-500">Fim: ${new Date(trip.end_time).toLocaleString('pt-BR')}</p>` : ''}
                        <p class="text-sm text-gray-500">KM: ${trip.initial_km}${trip.final_km ? ' - ' + trip.final_km + ' (' + (trip.final_km - trip.initial_km) + ' km)' : ''}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${statusBadge}
                        <button onclick="deleteTrip(${trip.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">
                            Excluir
                        </button>
                    </div>
                `;
                tripsContainer.appendChild(tripDiv);
            });
        }

        async function deleteTrip(tripId) {
            if (confirm('Tem certeza que deseja excluir esta viagem?')) {
                const { error } = await supabase
                    .from('trips')
                    .delete()
                    .eq('id', tripId);

                if (error) {
                    alert('Erro ao excluir viagem: ' + error.message);
                    return;
                }
                
                loadDriverTrips();
            }
        }

        async function clearAllTrips() {
            const driverId = parseInt(document.getElementById('tripDriverSelect').value);
            if (!driverId) return;

            if (confirm('Tem certeza que deseja zerar todas as viagens deste motorista?')) {
                const { error } = await supabase
                    .from('trips')
                    .delete()
                    .eq('driver_id', driverId); 

                if (error) {
                    alert('Erro ao zerar viagens: ' + error.message);
                    return;
                }
                
                loadDriverTrips();
            }
        }

        // **********************************************
        // GESTÃO DE VIAGENS - MOTORISTA SUPABASE (Usando snake_case para colunas)
        // **********************************************

        function loadDriverVehicles() {
            const select = document.getElementById('tripVehicle');
            const optionsToKeep = select.querySelector('option[value=""]');
            select.innerHTML = '';
            if (optionsToKeep) select.appendChild(optionsToKeep);

            vehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.id;
                option.textContent = `${vehicle.plate} - ${vehicle.model}`;
                select.appendChild(option);
            });
        }

        async function checkActiveTrip() {
            const activeTripSection = document.getElementById('activeTripSection');
            const newTripSection = document.getElementById('newTripSection');

            // Verifica se o currentUser está definido e é um motorista
            if (!currentUser || currentUser.type !== 'driver') {
                 activeTripSection.classList.add('hidden');
                 newTripSection.classList.add('hidden'); 
                 return;
            }
            
            const { data: activeTrip, error } = await supabase
                .from('trips')
                .select('*')
                .eq('driver_id', currentUser.id) 
                .eq('status', 'active')
                .single(); 

            if (error && error.code !== 'PGRST116') { // PGRST116 = Não encontrou linha (OK)
                console.error('Erro ao buscar viagem ativa:', error.message);
                activeTripSection.classList.add('hidden');
                newTripSection.classList.remove('hidden');
            }

            if (activeTrip) {
                const vehicle = vehicles.find(v => v.id === activeTrip.vehicle_id); 
                document.getElementById('activeTripDetails').innerHTML = `
                    <p><strong>Destino:</strong> ${activeTrip.destination}</p>
                    <p><strong>Veículo:</strong> ${vehicle ? vehicle.plate + ' - ' + vehicle.model : 'N/A'}</p>
                    <p><strong>KM Inicial:</strong> ${activeTrip.initial_km}</p>
                    <p><strong>Início:</strong> ${new Date(activeTrip.start_time).toLocaleString('pt-BR')}</p>
                `;
                activeTripSection.classList.remove('hidden');
                newTripSection.classList.add('hidden');
            } else {
                activeTripSection.classList.add('hidden');
                newTripSection.classList.remove('hidden');
            }
        }

        async function startTrip(event) {
            event.preventDefault();
            const destination = document.getElementById('tripDestination').value;
            const vehicleId = parseInt(document.getElementById('tripVehicle').value);
            const initialKm = parseInt(document.getElementById('initialKm').value);

            const newTrip = {
                driver_id: currentUser.id, 
                destination: destination,
                vehicle_id: vehicleId, 
                initial_km: initialKm, 
                start_time: new Date().toISOString(), 
                status: 'active'
            };

            const { error } = await supabase
                .from('trips')
                .insert([newTrip]);

            if (error) {
                alert('Erro ao iniciar viagem: ' + error.message);
                return;
            }

            document.getElementById('tripDestination').value = '';
            document.getElementById('tripVehicle').value = '';
            document.getElementById('initialKm').value = '';

            checkActiveTrip();
            loadDriverTripHistory();
        }

        async function finishTrip() {
            const finalKm = parseInt(document.getElementById('finalKm').value);
            if (!finalKm) {
                alert('Por favor, informe a KM final.');
                return;
            }

            const { data: activeTrip, error: fetchError } = await supabase
                .from('trips')
                .select('*')
                .eq('driver_id', currentUser.id) 
                .eq('status', 'active')
                .single();
            
            if (fetchError || !activeTrip) {
                alert('Nenhuma viagem ativa encontrada ou erro ao buscar.');
                return;
            }

            if (finalKm < activeTrip.initial_km) { 
                alert('KM final deve ser maior que KM inicial.');
                return;
            }
            
            const updateData = {
                final_km: finalKm, 
                end_time: new Date().toISOString(), 
                status: 'completed'
            };

            const { error } = await supabase
                .from('trips')
                .update(updateData)
                .eq('id', activeTrip.id);

            if (error) {
                alert('Erro ao finalizar viagem: ' + error.message);
                return;
            }

            document.getElementById('finalKm').value = '';
            checkActiveTrip();
            loadDriverTripHistory();
        }

        async function loadDriverTripHistory() {
            const historyDiv = document.getElementById('driverTripHistory');
            historyDiv.innerHTML = '<p class="text-gray-500">Carregando histórico...</p>';

            const { data: driverTrips, error } = await supabase
                .from('trips')
                .select('*')
                .eq('driver_id', currentUser.id) 
                .eq('status', 'completed')
                .order('end_time', { ascending: false }); 

            if (error) {
                historyDiv.innerHTML = `<p class="text-red-500">Erro ao carregar histórico: ${error.message}</p>`;
                return;
            }

            if (driverTrips.length === 0) {
                historyDiv.innerHTML = '<p class="text-gray-500">Nenhuma viagem concluída.</p>';
                return;
            }

            historyDiv.innerHTML = '<div class="space-y-3"></div>';
            const tripsContainer = historyDiv.querySelector('.space-y-3');

            driverTrips.forEach(trip => {
                const vehicle = vehicles.find(v => v.id === trip.vehicle_id); 
                const tripDiv = document.createElement('div');
                tripDiv.className = 'p-4 bg-gray-50 rounded-lg';
                tripDiv.innerHTML = `
                    <h5 class="font-medium text-gray-900">${trip.destination}</h5>
                    <p class="text-sm text-gray-500">${vehicle ? vehicle.plate + ' - ' + vehicle.model : 'Veículo não encontrado'}</p>
                    <p class="text-sm text-gray-500">Período: ${new Date(trip.start_time).toLocaleString('pt-BR')} - ${new Date(trip.end_time).toLocaleString('pt-BR')}</p>
                    <p class="text-sm text-gray-500">Quilometragem: ${trip.initial_km} - ${trip.final_km} (${trip.final_km - trip.initial_km} km)</p>
                `;
                tripsContainer.appendChild(tripDiv);
            });
        }

        // **********************************************
        // RELATÓRIOS SUPABASE (Usando snake_case para colunas)
        // **********************************************

        async function generateReport() {
            const driverId = parseInt(document.getElementById('reportDriverSelect').value);
            const period = parseInt(document.getElementById('reportPeriod').value);

            if (!driverId) {
                alert('Selecione um motorista.');
                return;
            }

            const driver = drivers.find(d => d.id === driverId);
            
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - period);
            const cutoffISODate = cutoffDate.toISOString();

            // 1. Busca as viagens no Supabase
            const { data: driverTrips, error } = await supabase
                .from('trips')
                .select('*')
                .eq('driver_id', driverId) 
                .eq('status', 'completed')
                .gte('start_time', cutoffISODate) 
                .order('start_time', { ascending: true }); 

            if (error) {
                alert('Erro ao buscar viagens para o relatório: ' + error.message);
                return;
            }

            if (driverTrips.length === 0) {
                alert('Nenhuma viagem encontrada no período selecionado.');
                return;
            }

            // Generate PDF using jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(20);
            doc.text('FleetControl - Relatório de Viagens', 20, 30);
            
            doc.setFontSize(12);
            doc.text(`Motorista: ${driver.name}`, 20, 50);
            doc.text(`Período: Últimos ${period} dias`, 20, 60);
            doc.text(`Data de Geração: ${new Date().toLocaleDateString('pt-BR')}`, 20, 70);

            // Trips table
            let yPosition = 90;
            doc.setFontSize(14);
            doc.text('Viagens Realizadas:', 20, yPosition);
            yPosition += 10;

            doc.setFontSize(10);
            driverTrips.forEach((trip, index) => {
                const vehicle = vehicles.find(v => v.id === trip.vehicle_id); 
                const startDate = new Date(trip.start_time).toLocaleDateString('pt-BR'); 
                const distance = trip.final_km - trip.initial_km; 

                doc.text(`${index + 1}. ${trip.destination}`, 20, yPosition);
                doc.text(`Veículo: ${vehicle ? vehicle.plate : 'N/A'}`, 30, yPosition + 8);
                doc.text(`Data: ${startDate}`, 30, yPosition + 16);
                doc.text(`Distância: ${distance} km`, 30, yPosition + 24);
                
                yPosition += 35;

                // Add new page if needed
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 30;
                }
            });

            // Summary
            const totalDistance = driverTrips.reduce((sum, trip) => sum + (trip.final_km - trip.initial_km), 0); 
            yPosition += 10;
            doc.setFontSize(12);
            doc.text(`Total de viagens: ${driverTrips.length}`, 20, yPosition);
            doc.text(`Quilometragem total: ${totalDistance} km`, 20, yPosition + 10);

            // Signature field
            yPosition += 40;
            doc.text('Assinatura: ________________________________', 20, yPosition);
            doc.text('Data: ___/___/______', 20, yPosition + 20);

            // Save PDF
            doc.save(`relatorio_${driver.name.replace(/\s+/g, '_')}_${period}dias.pdf`);
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('username').focus();
        });
    </script>
</body>
</html>
